<!DOCTYPE html>
<html lang="ja" prefix="og: http://ogp.me/ns#">
<head>
    <!-- 
      Cloudflare Pages & Functions SEO最適化版 v16.0
      - Functions連携: サーバー側でのOGP書き換えに対応
      - 多言語化(i18n): EN/JPスイッチおよびRPG×英語の4パターン対応
      - 新機能: 天気API (Open-Meteo) を用いたマジックアワー＆週間天気の自動表示
      - 新機能: Gemini API連携 三原の案内人タコちゃん (バックエンドAPI経由で安全に通信、UI調整済)
    -->

    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-LGXBBWLCPN"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-LGXBBWLCPN');
    </script>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    
    <!-- SEO Meta Tags -->
    <title>三原市まち歩き - PHOTO MAP | 三原市の魅力を再発見するプロジェクト</title>
    <meta name="description" content="広島県三原市の魅力を再発見するフォトマッププロジェクト。地元の人だけが知る絶景や隠れたスポットを写真と地図で紹介しています。">
    <meta name="keywords" content="三原市, 観光, 写真, マップ, 絶景, グルメ, 広島県, 瀬戸内海">
    
    <link rel="canonical" href="https://mihara-rediscover.pages.dev/" id="canonical-tag">

    <!-- OGP -->
    <meta property="og:type" content="website">
    <meta property="og:title" content="三原市まち歩き - PHOTO MAP">
    <meta property="og:description" content="まだ知らない三原の景色を、みんなで描くフォトマップ。">
    <meta property="og:site_name" content="三原市まち歩き - PHOTO MAP">
    <meta property="og:locale" content="ja_JP">
    <meta property="og:image" content="https://i.postimg.cc/Dy2sThhC/IMG-9586.jpg">
    
    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="三原市まち歩き - PHOTO MAP">
    <meta name="twitter:description" content="広島県三原市の魅力を再発見するフォトマッププロジェクト。">
    <meta name="twitter:image" content="https://i.postimg.cc/Dy2sThhC/IMG-9586.jpg">

    <!-- Icons -->
    <link rel="apple-touch-icon" href="apple-touch-icon.png">
    <link rel="icon" href="apple-touch-icon.png">

    <meta name="referrer" content="no-referrer">

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@500;700;900&family=Noto+Serif+JP:wght@700;900&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=DotGothic16&display=swap" rel="stylesheet">
    
    <!-- CSS / Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

    <!-- Leaflet -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />
    <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>

    <style>
        :root {
            --palette-blue: #004098;
            --palette-blue-light: #e1f5fe;
            --palette-sky: #f0f7ff;
            --palette-gold: #f5d76e;
            --text-main: #1a1a1a;
            --text-sub: #4b5563;
            --border-soft: #e2e8f0;
        }

        html { scroll-behavior: smooth; }

        *:not(i):not(svg):not(polyline):not(rect):not(path):not(circle):not(line):not(.emoji-icon) {
            font-family: 'Zen Maru Gothic', sans-serif !important;
            font-weight: 500;
        }

        .serif-custom {
            font-family: 'Noto Serif JP', serif !important;
            font-weight: 700 !important;
        }

        .emoji-icon { font-family: "Apple Color Emoji", "Segoe UI Emoji", "Noto Color Emoji", sans-serif !important; }

        body {
            color: var(--text-main);
            background-color: #fff;
            margin: 0;
            padding-top: 60px;
            overflow-x: hidden;
            -webkit-text-size-adjust: 100%;
            line-height: 1.8;
            transition: background-color 0.5s ease, color 0.5s ease;
        }

        /* --- ナビゲーション --- */
        .fixed-nav {
            position: fixed; top: 0; left: 0; width: 100%; height: 60px;
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(15px);
            border-bottom: 1px solid var(--border-soft);
            z-index: 9999;
            display: flex; justify-content: space-between; align-items: center;
            padding: 0 15px;
            transition: all 0.5s ease;
        }
        .header-logo { font-weight: 700 !important; font-size: 0.8rem; color: var(--palette-blue); letter-spacing: 0.05em; }
        .nav-links-wrap { display: flex; gap: 8px; align-items: center; }
        .nav-simple-link {
            font-size: 10px; font-weight: 700 !important; color: #9ca3af; cursor: pointer; transition: color 0.2s;
            text-decoration: none; white-space: nowrap;
        }
        .nav-simple-link:active, .nav-simple-link:hover { color: var(--palette-blue); }

        .header-btn {
            border: 1px solid var(--palette-blue);
            border-radius: 20px; cursor: pointer; font-size: 10px; font-weight: 700;
            transition: all 0.3s; display: flex; align-items: center; gap: 6px; white-space: nowrap;
        }
        #rpg-toggle-btn { background: var(--palette-blue); color: white; padding: 6px 14px; margin-left: 4px; box-shadow: 0 2px 6px rgba(0, 64, 152, 0.2); }
        #rpg-toggle-btn:hover { background: #00337a; transform: translateY(-1px); }
        #rpg-toggle-btn i { color: var(--palette-gold); font-size: 12px; }
        #lang-toggle-btn { background: transparent; color: var(--text-sub); border-color: var(--border-soft); padding: 5px 10px; }
        #lang-toggle-btn:hover { background: #f1f5f9; color: var(--palette-blue); }

        @media (min-width: 640px) {
            .header-logo { font-size: 1rem; letter-spacing: 0.1em; }
            .nav-links-wrap { gap: 20px; }
            .nav-simple-link { font-size: 12px; }
        }
        @media (max-width: 640px) {
            .nav-simple-link { font-size: 9px; }
            .nav-links-wrap { gap: 6px; } 
            #rpg-toggle-btn, #lang-toggle-btn { padding: 4px 8px; font-size: 9px; }
            @media (max-width: 370px) { .header-logo { display: none; } .fixed-nav { justify-content: center; } }
        }

        /* --- ヒーロー --- */
        .hero-view { position: relative; width: 100%; height: 80vh; height: 80dvh; background-color: #f7f7f7; overflow: hidden; }
        .slider-container { position: absolute; inset: 0; z-index: 1; }
        .slide { position: absolute; inset: 0; opacity: 0; transition: opacity 2s ease-in-out; }
        .slide.active { opacity: 1; }
        .slide img { width: 100%; height: 100%; object-fit: cover; }
        .hero-overlay { position: absolute; inset: 0; background: radial-gradient(circle, rgba(0,0,0,0.05) 0%, rgba(0,0,0,0.3) 100%); z-index: 2; }
        .hero-content { position: relative; z-index: 10; display: flex; flex-direction: column; justify-content: center; align-items: center; height: 100%; color: white; padding: 0 20px; text-align: center; }
        .hero-label { font-size: 0.75rem; font-weight: 700 !important; letter-spacing: 0.4em; color: var(--palette-gold); margin-bottom: 25px; display: block; text-shadow: 1px 1px 3px rgba(0,0,0,0.8); }
        .hero-title { font-size: 1.65rem; line-height: 1.8; text-shadow: 0 0 20px rgba(0,0,0,0.8), 0 2px 10px rgba(0,0,0,0.5); }
        .mobile-br { display: block; }
        @media (min-width: 640px) { .hero-title { font-size: 2.8rem; line-height: 1.6; } .mobile-br { display: none; } }

        /* --- セクション全般 --- */
        .section-wrap { padding: 100px 24px; scroll-margin-top: 60px; position: relative; transition: background-color 0.5s ease; }
        .inner-limit { max-width: 750px; margin: 0 auto; text-align: center; }
        .section-tag-label { font-size: 0.8rem; font-weight: 700 !important; color: var(--palette-blue); letter-spacing: 0.25em; margin-bottom: 40px; display: block; text-transform: uppercase; }
        .card-frame { background: white; border-radius: 12px; padding: 40px 25px; margin-bottom: 30px; text-align: left; border: 1px solid var(--border-soft); box-shadow: 0 10px 30px rgba(0,64,152,0.03); transition: all 0.5s ease; }
        .card-frame h4 { font-weight: 700 !important; color: var(--palette-blue); margin-bottom: 12px; font-size: 1rem; border-left: 5px solid var(--palette-blue); padding-left: 15px; }
        .card-frame p { font-size: 0.85rem; font-weight: 500 !important; line-height: 2.3; color: var(--text-sub); }

        /* --- ギャラリー / MAP --- */
        .sticky-tab-bar { position: sticky; top: 60px; background: rgba(255,255,255,0.98); z-index: 900; border-bottom: 2px solid var(--palette-blue); overflow-x: auto; white-space: nowrap; transition: all 0.5s ease; }
        .sticky-tab-bar::-webkit-scrollbar { display: none; }
        .tab-flex { display: flex; padding: 0 10px; justify-content: center; }
        .tab-item { padding: 22px 18px; font-size: 0.85rem; font-weight: 700 !important; color: #9ca3af; border-bottom: 4px solid transparent; cursor: pointer; }
        .tab-item.active { color: var(--palette-blue); border-bottom-color: var(--palette-blue); }
        @media (max-width: 640px) { .tab-flex { justify-content: flex-start; } }

        .view-switch { display: inline-flex; background: #f1f5f9; padding: 4px; border-radius: 50px; margin-bottom: 20px; transition: all 0.5s ease; }
        .view-btn { padding: 8px 24px; border-radius: 40px; font-size: 11px; font-weight: 700; cursor: pointer; transition: all 0.3s; color: #64748b; display: flex; align-items: center; }
        .view-btn.active { background: white; color: var(--palette-blue); box-shadow: 0 2px 5px rgba(0,0,0,0.05); }

        .photo-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 1px; background: var(--border-soft); }
        @media (min-width: 768px) { .photo-grid { grid-template-columns: repeat(4, 1fr); } }
        
        .photo-item { position: relative; aspect-ratio: 1/1; background: #f3f4f6; overflow: hidden; cursor: pointer; }
        .photo-item img { width: 100%; height: 100%; object-fit: cover; transition: transform 0.8s cubic-bezier(0.2, 0.8, 0.2, 1); }
        .photo-overlay { position: absolute; inset: 0; background: linear-gradient(to top, rgba(0,0,0,0.6) 0%, rgba(0,0,0,0) 80%); opacity: 0; transition: opacity 0.6s ease; display: flex; flex-direction: column; justify-content: flex-end; padding: 10px; pointer-events: none; }
        .photo-overlay span { transform: translateY(15px); opacity: 0; transition: transform 0.6s cubic-bezier(0.215, 0.61, 0.355, 1), opacity 0.6s ease; }
        @media (hover: hover) {
            .photo-item:hover img { transform: scale(1.1); }
            .photo-item:hover .photo-overlay { opacity: 1; }
            .photo-item:hover .photo-overlay span { transform: translateY(0); opacity: 1; }
            .photo-item:hover .photo-overlay span:nth-child(2) { transition-delay: 0.05s; }
        }
        @media (hover: none) {
            .photo-item.in-view .photo-overlay { opacity: 1; transition-delay: 0.1s; }
            .photo-item.in-view .photo-overlay span { transform: translateY(0); opacity: 1; transition-delay: 0.3s; }
            .photo-item.in-view .photo-overlay span:nth-child(2) { transition-delay: 0.4s; }
        }
        
        #map-container { height: 60vh; min-height: 500px; width: 100%; z-index: 1; display: none; border-bottom: 1px solid var(--border-soft); }
        #map-container.active { display: block; }
        .leaflet-popup-content-wrapper { border-radius: 8px; overflow: hidden; padding: 0; box-shadow: 0 10px 25px rgba(0,0,0,0.15); }
        .leaflet-popup-content { margin: 0; width: 220px !important; }
        .popup-img-wrap { width: 100%; height: 130px; overflow: hidden; position: relative; background: #f3f4f6; }
        .popup-img { width: 100%; height: 100%; object-fit: cover; }
        .popup-info { padding: 12px; background: white; transition: background 0.5s ease; }
        .popup-title { font-size: 13px; font-weight: bold; color: var(--palette-blue); margin-bottom: 2px; line-height: 1.4; font-family: 'Noto Serif JP', serif !important; }
        .popup-area { font-size: 9px; color: #999; text-transform: uppercase; letter-spacing: 0.1em; font-weight: 700; margin-bottom: 4px; display: block; }
        .popup-more { font-size: 10px; color: var(--palette-blue); display: flex; align-items: center; justify-content: flex-end; gap: 4px; font-weight: 700; margin-top: 5px; }
        .marker-cluster-small, .marker-cluster-medium, .marker-cluster-large { background-color: rgba(0, 64, 152, 0.2) !important; }
        .marker-cluster-small div, .marker-cluster-medium div, .marker-cluster-large div { background-color: var(--palette-blue) !important; color: #fff !important; font-family: 'Zen Maru Gothic', sans-serif !important; font-weight: 900 !important; box-shadow: 0 4px 10px rgba(0, 64, 152, 0.3); }

        /* --- 募集セクション --- */
        .h2-one-line { font-size: 1.6rem; font-weight: 700 !important; margin-bottom: 50px; line-height: 1.2; text-align: center; white-space: nowrap; letter-spacing: -0.07em; color: var(--palette-blue); }
        .insta-cta-box { margin-top: 60px; padding: 40px 20px; background: #fff; border: 2px dashed var(--palette-blue-light); border-radius: 20px; display: flex; flex-direction: column; align-items: center; gap: 20px; }
        .insta-btn-final { display: flex; align-items: center; justify-content: center; gap: 10px; background: linear-gradient(45deg, #f09433, #e6683c, #dc2743, #cc2366, #bc1888); color: white !important; padding: 18px 45px; border-radius: 100px; font-weight: 700 !important; text-decoration: none; font-size: 1rem; box-shadow: 0 10px 25px rgba(220, 39, 67, 0.25); white-space: nowrap; }

        .img-divider-box { position: relative; width: 100%; height: auto; min-height: 320px; aspect-ratio: 16/9; overflow: hidden; border-top: 1px solid var(--border-soft); border-bottom: 1px solid var(--border-soft); background: #f3f4f6; }
        .img-divider-box img { position: absolute; inset: 0; width: 100%; height: 100%; object-fit: cover; z-index: 1; }
        .img-divider-content { position: relative; z-index: 2; height: 100%; display: flex; align-items: flex-end; padding: 25px; }

        .bottom-view-container { position: relative; width: 100%; height: auto; min-height: 450px; aspect-ratio: 4/5; overflow: hidden; border-top: 1px solid var(--border-soft); background: #f3f4f6; }
        @media (min-width: 640px) { .bottom-view-container { aspect-ratio: 16/7; } }
        .bottom-view-container img { position: absolute; inset: 0; width: 100%; height: 100%; object-fit: cover; z-index: 1; }
        .bottom-view-overlay { position: relative; z-index: 2; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: flex-start; padding-top: 50px; }
        .floating-badge { background: rgba(255,255,255,0.15); backdrop-filter: blur(10px); padding: 20px 35px; text-align: center; border: 1px solid rgba(255,255,255,0.3); border-radius: 4px; }

        /* フッター */
        .footer-main { text-align: center; background-color: #fff; border-top: 1px solid var(--border-soft); padding: 60px 20px 60px 20px; transition: background-color 0.5s ease; }
        .footer-copy { font-size: 9px; font-weight: 700 !important; color: #9ca3af; letter-spacing: 0.3em; margin-bottom: 12px; text-transform: uppercase; }
        .footer-produced { font-size: 8px; font-weight: 500 !important; color: #cbd5e1; letter-spacing: 0.1em; text-transform: uppercase; margin-bottom: 8px; }

        /* モーダル */
        .modal-wrap { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 10000; background: white; overflow-y: auto; transition: background-color 0.5s ease; }
        .modal-wrap.active { display: block; }
        .modal-close { position: fixed; top: 15px; right: 15px; background: white; border: 1px solid #eee; width: 44px; height: 44px; border-radius: 50%; display: flex; align-items: center; justify-content: center; z-index: 11000; box-shadow: 0 4px 10px rgba(0,0,0,0.05); cursor: pointer; transition: transform 0.2s, background-color 0.5s ease; }
        .modal-close:hover { transform: rotate(90deg); }

        .share-btn-group { display: flex; gap: 12px; justify-content: center; flex-wrap: wrap; margin-bottom: 10px; }
        .share-btn { display: flex; align-items: center; justify-content: center; width: 40px; height: 40px; border-radius: 50%; background: #f1f5f9; color: #64748b; font-size: 16px; transition: all 0.3s; text-decoration: none; border: 1px solid transparent; }
        .share-btn:hover { transform: translateY(-2px); color: white; }
        .share-btn.x-twitter:hover { background: #000; color: #fff; }
        #copy-success-msg { font-size: 10px; font-weight: bold; color: var(--palette-blue); opacity: 0; transition: opacity 0.3s ease; height: 14px; }
        #copy-success-msg.show { opacity: 1; }

        /* --- 冒険の書モード (RPG Mode) --- */
        body.rpg-mode { background-color: #000 !important; color: #fff !important; font-family: 'DotGothic16', sans-serif !important; }
        body.rpg-mode *:not(i):not(.emoji-icon) { font-family: 'DotGothic16', sans-serif !important; letter-spacing: 0.1em; }
        body.rpg-mode img { filter: none; image-rendering: auto; }
        body.rpg-mode .leaflet-layer { filter: contrast(120%) saturate(200%); image-rendering: pixelated; image-rendering: crisp-edges; }
        body.rpg-mode .card-frame, body.rpg-mode .fixed-nav, body.rpg-mode .sticky-tab-bar, body.rpg-mode .popup-info, body.rpg-mode .insta-cta-box, body.rpg-mode .footer-main, body.rpg-mode .section-wrap:nth-child(even) { background: #00008b !important; border: 3px double #fff !important; border-radius: 4px !important; color: #fff !important; box-shadow: 0 0 0 2px #000; }
        body.rpg-mode #modal-content-area { background: #00008b !important; border: 3px double #fff !important; box-shadow: 0 0 0 2px #000; color: #fff !important; }
        body.rpg-mode .modal-wrap { background: rgba(0,0,0,0.85) !important; }
        body.rpg-mode .modal-close { background: #000 !important; border: 2px solid #fff !important; color: #fff !important; }
        body.rpg-mode #modal-map-btn { background: #000 !important; border: 2px solid #fff !important; color: #ff0 !important; }
        body.rpg-mode .section-wrap { background-color: #000 !important; }
        body.rpg-mode #contact { border-top: none !important; }
        body.rpg-mode h1, body.rpg-mode h2, body.rpg-mode h3, body.rpg-mode h4, body.rpg-mode h5, body.rpg-mode p, body.rpg-mode span, body.rpg-mode a, body.rpg-mode div, body.rpg-mode li, body.rpg-mode #modal-title, body.rpg-mode #modal-desc, body.rpg-mode #modal-author, body.rpg-mode .share-label { color: #fff !important; text-shadow: 2px 2px 0 #000; }
        body.rpg-mode .text-blue-900, body.rpg-mode .section-tag-label, body.rpg-mode h4, body.rpg-mode #modal-area, body.rpg-mode #modal-sns, body.rpg-mode #copy-success-msg { color: #f5d76e !important; border-color: #f5d76e !important; }
        body.rpg-mode .view-switch, body.rpg-mode .view-btn, body.rpg-mode .tab-item, body.rpg-mode .share-btn { background: #000 !important; border: 2px solid #fff !important; color: #fff !important; margin: 2px; border-radius: 4px; }
        body.rpg-mode .view-btn.active, body.rpg-mode .tab-item.active { background: #a52a2a !important; color: #ff0 !important; border-color: #ff0 !important; }
        body.rpg-mode #rpg-toggle-btn, body.rpg-mode #lang-toggle-btn { background: #000 !important; border: 2px solid #fff !important; color: #fff !important; border-radius: 4px; }

        body.rpg-mode #weather-widget { background: #00008b !important; border: 3px double #fff !important; margin-bottom: 30px; }
        body.rpg-mode #weather-widget * { border-color: #fff !important; }
        body.rpg-mode #weather-icon-bg { background: transparent !important; color: #ff0 !important; border: 2px solid #fff !important; box-shadow: none; }
        body.rpg-mode #weather-temp-text { color: #fff !important; }
        body.rpg-mode #weather-desc { background: #000 !important; color: #fff !important; border-color: #fff !important; }
        body.rpg-mode .weather-magic-box { background: #000 !important; border: 1px solid #fff !important; }
        body.rpg-mode .weather-magic-box .text-orange-500, body.rpg-mode .weather-magic-box .text-orange-400, body.rpg-mode .weather-magic-box .text-blue-400 { color: #f5d76e !important; }
        body.rpg-mode .weather-magic-box .text-slate-800, body.rpg-mode .weather-magic-box .text-slate-600 { color: #fff !important; }
        body.rpg-mode #weekly-toggle-wrap { border-color: #fff !important; }
        body.rpg-mode #weekly-toggle-btn { color: #f5d76e !important; }
        body.rpg-mode .weekly-day-label { color: #fff !important; }
        body.rpg-mode #weekly-forecast-list i { color: #fff !important; }

        /* --- ★ 新機能：AIチャット UI (画像タコちゃんVer) --- */
        #ai-chat-widget { position: fixed; bottom: 20px; right: 20px; z-index: 10000; display: flex; flex-direction: column; align-items: flex-end; }
        #ai-chat-btn { 
            width: 70px; height: 70px; border-radius: 50%; 
            background-color: white; border: none; /* ★青い枠線を削除 */
            cursor: pointer; box-shadow: 0 6px 20px rgba(0,64,152,0.3); 
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); 
            display: flex; justify-content: center; align-items: center; 
            padding: 0; overflow: hidden; /* 画像を丸く切り抜く */
        }
        #ai-chat-btn img { width: 100%; height: 100%; object-fit: cover; }
        #ai-chat-btn:hover { transform: scale(1.1) rotate(5deg); box-shadow: 0 8px 25px rgba(0,64,152,0.4); }
        
        #ai-chat-window { position: absolute; bottom: 90px; right: 0; width: 340px; height: 480px; max-height: 80vh; max-width: calc(100vw - 40px); background: white; border-radius: 16px; box-shadow: 0 8px 30px rgba(0,0,0,0.15); display: flex; flex-direction: column; overflow: hidden; border: 1px solid var(--border-soft); transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); transform-origin: bottom right; }
        #ai-chat-window.hidden { opacity: 0; transform: scale(0.5); pointer-events: none; }
        #ai-chat-header { background: var(--palette-blue); color: white; padding: 12px 16px; font-weight: bold; display: flex; justify-content: space-between; align-items: center; font-size: 14px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        #ai-chat-header button { background: none; border: none; color: white; font-size: 18px; cursor: pointer; opacity: 0.8; transition: opacity 0.2s; }
        #ai-chat-header button:hover { opacity: 1; }
        #ai-chat-messages { flex: 1; padding: 16px; overflow-y: auto; background: #f8fafc; display: flex; flex-direction: column; gap: 14px; scroll-behavior: smooth; }
        .chat-msg { max-width: 85%; padding: 12px 16px; border-radius: 18px; font-size: 13px; line-height: 1.6; word-wrap: break-word; position: relative; }
        .ai-msg { background: white; color: var(--text-main); border: 1px solid var(--border-soft); align-self: flex-start; border-bottom-left-radius: 4px; box-shadow: 0 2px 5px rgba(0,0,0,0.02); }
        .user-msg { background: var(--palette-blue); color: white; align-self: flex-end; border-bottom-right-radius: 4px; box-shadow: 0 2px 5px rgba(0,64,152,0.2); }
        .chat-msg strong { color: var(--palette-blue); font-weight: 900; }
        .user-msg strong { color: #f5d76e; }
        #ai-chat-input-area { display: flex; padding: 12px; background: white; border-top: 1px solid var(--border-soft); gap: 8px; align-items: center; }
        #ai-chat-input { flex: 1; border: 1px solid var(--border-soft); background: #f1f5f9; border-radius: 24px; padding: 10px 16px; font-size: 13px; outline: none; transition: all 0.3s; font-family: 'Zen Maru Gothic', sans-serif; }
        #ai-chat-input:focus { border-color: var(--palette-blue); background: white; box-shadow: 0 0 0 3px rgba(0,64,152,0.1); }
        
        /* ★ 紙飛行機ボタンのはみ出し防止と位置微調整 */
        #ai-chat-send-btn { 
            width: 40px; height: 40px; min-width: 40px; 
            border-radius: 50%; background: var(--palette-blue); color: white; border: none; 
            cursor: pointer; display: flex; justify-content: center; align-items: center; 
            transition: background 0.2s; flex-shrink: 0; font-size: 15px; 
            padding: 0; box-sizing: border-box;
        }
        #ai-chat-send-btn i { 
            transform: translate(-1px, 1px); /* アイコンを少し左下にずらして中央に見せる */
        }
        #ai-chat-send-btn:hover { background: #00337a; }
        #ai-chat-send-btn:disabled { background: #cbd5e1; cursor: not-allowed; }

        /* ★ タコちゃんの吹き出しスタイル */
        .ai-tooltip {
            position: absolute;
            bottom: 85px;
            right: 15px;
            background-color: white;
            color: var(--palette-blue);
            padding: 10px 16px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 900;
            box-shadow: 0 4px 15px rgba(0,64,152,0.15);
            white-space: nowrap;
            pointer-events: none;
            transition: opacity 0.3s, transform 0.3s;
            transform-origin: bottom right;
            animation: bounce-tooltip 2.5s infinite ease-in-out;
            border: 2px solid var(--palette-blue);
        }
        .ai-tooltip::after {
            content: '';
            position: absolute;
            bottom: -8px;
            right: 20px;
            width: 0;
            height: 0;
            border-left: 8px solid transparent;
            border-right: 8px solid transparent;
            border-top: 8px solid var(--palette-blue);
        }
        .ai-tooltip::before {
            content: '';
            position: absolute;
            bottom: -5px;
            right: 21px;
            width: 0;
            height: 0;
            border-left: 7px solid transparent;
            border-right: 7px solid transparent;
            border-top: 7px solid white;
            z-index: 1;
        }
        @keyframes bounce-tooltip {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }
        /* チャットが開いている時は吹き出しを隠す */
        #ai-chat-widget.open .ai-tooltip {
            opacity: 0;
            transform: scale(0.8);
        }

        /* RPG Mode for Chat */
        body.rpg-mode #ai-chat-btn { border: none !important; border-radius: 4px; box-shadow: 2px 2px 0 #fff; padding: 2px; background: #000; }
        body.rpg-mode #ai-chat-btn img { border-radius: 0; image-rendering: pixelated; }
        body.rpg-mode #ai-chat-window { background: #00008b !important; border: 4px double #fff !important; border-radius: 4px; box-shadow: 4px 4px 0 #000; }
        body.rpg-mode #ai-chat-header { background: #000 !important; color: #fff !important; border-bottom: 2px solid #fff; }
        body.rpg-mode #ai-chat-messages { background: #000 !important; }
        body.rpg-mode .ai-msg { background: #00008b !important; border: 2px solid #fff !important; color: #fff !important; border-radius: 4px; }
        body.rpg-mode .ai-msg strong { color: #ff0 !important; }
        body.rpg-mode .user-msg { background: #a52a2a !important; border: 2px solid #fff !important; color: #fff !important; border-radius: 4px; }
        body.rpg-mode #ai-chat-input-area { background: #000 !important; border-top: 2px solid #fff; }
        body.rpg-mode #ai-chat-input { background: #000 !important; border: 2px solid #fff !important; color: #fff !important; border-radius: 0; font-family: 'DotGothic16', sans-serif !important; box-shadow: none; }
        body.rpg-mode #ai-chat-input::placeholder { color: #888; }
        body.rpg-mode #ai-chat-send-btn { background: #000 !important; border: 2px solid #fff !important; color: #ff0 !important; border-radius: 4px; }
        
        /* RPGモード時の吹き出し */
        body.rpg-mode .ai-tooltip { background: #00008b !important; color: #fff !important; border: 3px double #fff !important; border-radius: 4px; box-shadow: 4px 4px 0 #000; animation: none; font-family: 'DotGothic16', sans-serif !important; }
        body.rpg-mode .ai-tooltip::after { border-top-color: #fff; bottom: -9px; }
        body.rpg-mode .ai-tooltip::before { display: none; }
    </style>
</head>
<body id="top">

    <!-- ナビゲーション（ヘッダー） -->
    <nav class="fixed-nav">
        <div class="header-logo" id="header-logo" data-i18n="header-logo">MIHARA REDISCOVER</div>
        <div class="nav-links-wrap">
            <div class="nav-simple-link" onclick="scrollToId('gallery')" data-i18n="nav-map">マップ</div>
            <div class="nav-simple-link" onclick="scrollToId('contact')" data-i18n="nav-submit">掲載募集</div>
            <div class="nav-simple-link" onclick="scrollToId('guideline')" data-i18n="nav-guide">掲載案内</div>
            
            <button id="rpg-toggle-btn" class="header-btn" onclick="toggleRPGMode()">
                <i id="rpg-btn-icon" class="fa-solid fa-dungeon"></i> <span id="rpg-btn-text">冒険の扉</span>
            </button>
            <button id="lang-toggle-btn" class="header-btn" onclick="toggleLanguage()">
                <i class="fa-solid fa-globe"></i> <span id="lang-text">EN</span>
            </button>
        </div>
    </nav>

    <!-- ヒーロー -->
    <section class="hero-view">
        <div class="slider-container">
            <div class="slide active"><img src="https://i.postimg.cc/Dy2sThhC/IMG-9586.jpg" alt="桜"></div>
            <div class="slide"><img src="https://i.postimg.cc/Z56hFGB9/IMG-9585.jpg" alt="旗"></div>
            <div class="slide"><img src="https://i.postimg.cc/cLypHF9y/IMG-9584.jpg" alt="海"></div>
        </div>
        <div class="hero-overlay"></div>
        <div class="hero-content">
            <span class="hero-label" id="hero-label" data-i18n="hero-label">MIHARA REDISCOVER PROJECT</span>
            <h1 class="hero-title serif-custom" id="hero-title" data-i18n="hero-title">
                まだ知らない三原の景色を、<br class="mobile-br">
                みんなで描くフォトマップ
            </h1>
        </div>
    </section>

    <!-- 1. ABOUT -->
    <section id="about" class="section-wrap bg-white">
        <div class="inner-limit">
            <span class="section-tag-label" id="label-about" data-i18n="label-about">About Project</span>
            <h3 class="serif-custom text-blue-900 text-2xl mb-12" id="title-about" data-i18n="title-about">みんなで描く、三原の未来</h3>
            <div class="card-frame border-2 border-blue-50" id="card-about">
                <p class="text-sm font-bold text-justify" data-i18n="desc-about">
                    広島県三原市（みはらし）は、瀬戸内海の穏やかな気候と豊かな自然に恵まれた、歴史と文化が息づく街です。陸・海・空の交通の要衝として知られ、「広島空港」がある空の玄関口でもあります。<br><br>
                    このプロジェクトは、そんな三原の日常にある「美しさ」を再発見するためのもの。地元の人だけが知る特別な場所や、日常のふとした風景を写真で紡ぎ、共有していきます。
                </p>
            </div>
        </div>
    </section>

    <!-- 2. ギャラリー / MAP Area -->
    <section id="gallery" class="bg-white" style="padding-top: 0;">
        <div class="pt-0 pb-8 px-6 text-center">
            <h3 class="serif-custom text-blue-900 text-2xl mb-4" id="title-map" data-i18n="title-map">PHOTO MAP</h3>
            <p id="sub-map" class="text-[10px] font-bold text-gray-500 uppercase tracking-widest mb-6" data-i18n="sub-map">Find Your Favorite Spot</p>
            
            <!-- ウェザー＆マジックアワー ウィジェット -->
            <div id="weather-widget" class="bg-white rounded-[12px] p-4 mx-auto mb-8 max-w-[90%] sm:max-w-md shadow-[0_4px_20px_rgba(0,64,152,0.06)] border border-blue-50" style="margin-top: -10px;">
                <div class="flex items-center justify-between mb-4 px-1">
                    <div class="flex items-center gap-3">
                        <div class="bg-blue-50 text-blue-500 rounded-full w-10 h-10 flex items-center justify-center text-lg shadow-inner border border-blue-100" id="weather-icon-bg">
                            <i id="weather-main-icon" class="fa-solid fa-spinner fa-spin"></i>
                        </div>
                        <div class="text-left leading-tight">
                            <span class="block text-[9px] font-bold text-gray-400 uppercase tracking-widest" data-i18n="weather-mihara">MIHARA WEATHER</span>
                            <span class="block text-xl font-bold text-blue-900" id="weather-temp-text">--°C</span>
                        </div>
                    </div>
                    <div class="text-[11px] font-bold text-gray-600 bg-gray-50 px-3 py-1.5 rounded-full border border-gray-100 shadow-sm" id="weather-desc">取得中...</div>
                </div>
                
                <div class="weather-magic-box bg-gradient-to-r from-orange-50/80 to-blue-50/80 rounded-[8px] p-3 flex items-center gap-3 border border-orange-100/50">
                    <div class="w-8 h-8 flex items-center justify-center text-orange-400">
                        <i class="fa-solid fa-camera-retro text-lg"></i>
                    </div>
                    <div class="flex-1 text-left leading-tight">
                        <span class="block text-[8px] font-bold text-orange-500 uppercase tracking-widest mb-0.5" data-i18n="weather-magic-hour">MAGIC HOUR</span>
                        <span class="block text-[13px] font-bold text-slate-800" id="magic-hour-text">夕焼けチャンス: --:--</span>
                    </div>
                    <div class="text-right border-l border-slate-200 pl-3">
                        <span class="block text-[8px] font-bold text-blue-400 uppercase tracking-widest mb-0.5" data-i18n="weather-sunrise">SUNRISE</span>
                        <span class="block text-[13px] font-bold text-slate-600" id="sunrise-text">--:--</span>
                    </div>
                </div>

                <div class="mt-3 pt-2 border-t border-dashed border-blue-100" id="weekly-toggle-wrap">
                    <button onclick="toggleWeeklyWeather()" class="w-full text-[10px] font-bold text-gray-500 hover:text-blue-600 transition-colors flex items-center justify-center gap-1.5" id="weekly-toggle-btn">
                        <span data-i18n="weather-weekly-toggle">週間天気を見る</span>
                        <i class="fa-solid fa-chevron-down text-[8px] transition-transform duration-300" id="weekly-toggle-icon"></i>
                    </button>
                    <div id="weekly-weather-container" class="overflow-hidden transition-all duration-300" style="max-height: 0px; opacity: 0;">
                        <div class="pt-4 pb-1 flex justify-between gap-1 overflow-x-auto" id="weekly-forecast-list"></div>
                    </div>
                </div>
            </div>

            <div class="view-switch">
                <div id="btn-view-grid" class="view-btn active" onclick="switchView('grid')">
                    <i class="fa-solid fa-border-all mr-2"></i> <span data-i18n="btn-view-grid-text">PHOTO</span>
                </div>
                <div id="btn-view-map" class="view-btn" onclick="switchView('map')">
                    <i class="fa-solid fa-map-location-dot mr-2"></i> <span data-i18n="btn-view-map-text">MAP</span>
                </div>
            </div>
        </div>

        <nav class="sticky-tab-bar">
            <div class="tab-flex">
                <div class="tab-item active" data-area="all">ぜんぶ</div>
                <div class="tab-item" data-area="mihara">三原市街</div>
                <div class="tab-item" data-area="daiwa">大和</div>
                <div class="tab-item" data-area="kui">久井</div>
                <div class="tab-item" data-area="hongo">本郷</div>
                <div class="tab-item" data-area="sagi">佐木島</div>
            </div>
        </nav>
        
        <div id="gallery-wrap">
            <div id="gallery-grid" class="photo-grid">
                <div class="col-span-3 py-32 text-center text-[10px] font-bold text-slate-300 uppercase tracking-widest" data-i18n="loading-text">Collecting memories...</div>
            </div>
            <div id="load-more-area" class="text-center py-10 hidden">
                <button onclick="loadMoreItems()" class="bg-[#004098] text-white text-xs font-bold py-3 px-10 rounded-full hover:opacity-90 transition shadow-lg tracking-widest" data-i18n="load-more-btn">MORE PHOTOS</button>
            </div>
        </div>
        <div id="map-container"></div>
    </section>

    <!-- 3. 掲載募集 -->
    <section id="contact" class="section-wrap" style="background-color: var(--palette-sky); border-top: 1px solid var(--border-soft);">
        <div class="inner-limit">
            <span class="section-tag-label" id="label-contact" data-i18n="label-contact">Photo Submission</span>
            <h2 class="h2-one-line serif-custom" id="title-contact" data-i18n="title-contact">三原の魅力を教えてください</h2>
            <p id="text-contact-desc" class="text-sm text-gray-500 leading-loose font-bold mb-8" data-i18n="desc-contact">
                隠れた名所、美味しいグルメ、四季折々の風景、まちのイベント、あるいは何気ない日常のひとコマなど、三原の魅力が伝わる写真を幅広く募集しています。
            </p>
            <div class="bg-white/60 p-6 rounded-lg border border-blue-100 shadow-sm inline-block text-center mb-12 insta-cta-box" style="margin-top:0; border-radius:8px; border-style:solid; border-width:1px;">
                <p class="text-xs text-blue-900 leading-loose font-bold" data-i18n="contact-step-1">
                    以下の情報を添えて、Instagram<br>
                    （<a href="https://www.instagram.com/mihara_sampo" target="_blank" rel="noopener noreferrer" class="underline decoration-blue-300">@mihara_sampo</a>）のDMよりお送りください。<br>
                    内容を確認の上、サイトに追加させていただきます！
                </p>
            </div>
            <div class="card-frame border-2 border-blue-100">
                <h5 class="text-center font-bold text-[10px] border-b pb-4 mb-6 tracking-widest uppercase text-blue-900" data-i18n="req-info-title">Required Information</h5>
                <ul class="text-[11px] font-bold space-y-4 text-gray-600">
                    <li class="flex items-center gap-2"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#004098" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg> <span data-i18n="req-info-1">写真データ (JPEG/PNGなど)</span></li>
                    <li class="flex items-center gap-2"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#004098" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg> <span data-i18n="req-info-2">スポット名 / 紹介コメント</span></li>
                    <li class="flex items-center gap-2"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#004098" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg> <span data-i18n="req-info-3">撮影者名 / SNSリンク (任意)</span></li>
                </ul>
            </div>
            <div class="insta-cta-box">
                <p class="text-[10px] font-bold text-gray-400 uppercase tracking-widest" data-i18n="contact-via-insta">Contact via Instagram</p>
                <a href="https://www.instagram.com/mihara_sampo" target="_blank" rel="noopener noreferrer" class="insta-btn-final">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="2" width="20" height="20" rx="5" ry="5"></rect><path d="M16 11.37A4 4 0 1 1 12.63 8 4 4 0 0 1 16 11.37z"></path><line x1="17.5" y1="6.5" x2="17.51" y2="6.5"></line></svg>
                    <span data-i18n="insta-btn-text">InstagramでDMを送る</span>
                </a>
            </div>
        </div>
    </section>

    <!-- イメージ -->
    <div class="img-divider-box">
        <img src="https://i.postimg.cc/FFc54tpJ/IMG-9587.jpg" alt="SUNAMI BEACH PARK" onerror="this.style.display='none'">
        <div class="img-divider-content">
            <span class="text-white text-[10px] font-bold tracking-widest bg-black/40 p-2 rounded uppercase shadow-xl">SUNAMI BEACH PARK</span>
        </div>
    </div>

    <!-- 4. 掲載案内 -->
    <section id="guideline" class="section-wrap" style="background-color: var(--palette-sky);">
        <div class="inner-limit">
            <span class="section-tag-label" id="label-guideline" data-i18n="label-guideline">Guidelines</span>
            <h2 class="h2-one-line serif-custom text-slate-800" id="title-guideline" data-i18n="title-guideline">写真掲載についてのご案内</h2>
            <div class="space-y-6">
                <div class="card-frame">
                    <h4 data-i18n="guide-1-title">写真掲載のルール</h4>
                    <p data-i18n="guide-1-desc">地域の魅力を伝えることを目的に、風景やお店、日常のひとコマを掲載しています。どなたでも自由に掲載できる仕組みではなく、ご連絡をいただいた内容を確認した上で掲載を行っています。</p>
                </div>
                <div class="card-frame">
                    <h4 data-i18n="guide-2-title">権利とマナー</h4>
                    <p data-i18n="guide-2-desc">著作権は撮影者本人にあります。人物や私有地が写る場合は、必ず権利者の許可を得てからご投稿ください。不適切な写真は掲載を見送る場合がございます。</p>
                </div>
                <div class="card-frame">
                    <h4 data-i18n="guide-3-title">写真の取り扱い</h4>
                    <p data-i18n="guide-3-desc">ご提供いただいた写真は、当サイトや関連SNSにおいて三原を盛り上げる広報活動に大切に使用させていただきます。投稿者さんの意思を尊重し、丁寧に扱わせていただきます。</p>
                </div>
            </div>
        </div>
    </section>

    <section class="bottom-view-container">
        <img src="https://i.postimg.cc/Df1DNrfM/IMG-9590.jpg" alt="三原港パノラマ" onerror="this.style.display='none'">
        <div class="bottom-view-overlay">
            <div class="floating-badge">
                <p class="serif-custom italic text-2xl mb-1 text-white">Beautiful Mihara,</p>
                <p class="text-white text-[9px] font-bold tracking-[0.4em] uppercase">REDISCOVER PROJECT</p>
            </div>
        </div>
    </section>

    <!-- ★確実にフッターを元に戻しました -->
    <footer class="footer-main">
        <p class="footer-copy" data-i18n="footer-copy">&copy; 2026 Mihara Walk Photo Map</p>
        <p class="footer-produced">PRODUCED BY MICHIM | PHOTOS BY MIHARA LOVERS</p>
    </footer>

    <!-- 写真詳細モーダル -->
    <div id="photo-modal" class="modal-wrap">
        <button id="modal-close-btn" class="modal-close"><i class="fa-solid fa-xmark"></i></button>
        <div id="modal-content-area" class="max-w-[600px] mx-auto pb-24 bg-white min-h-screen sm:min-h-0">
            <img id="modal-img" src="" class="w-full aspect-square object-cover" onerror="this.style.display='none'">
            <div class="px-8 py-12 text-left">
                <span id="modal-area" class="text-[9px] font-bold tracking-widest text-blue-600 border border-blue-600 px-3 py-1 mb-6 inline-block uppercase">AREA</span>
                <h2 id="modal-title" class="serif-custom text-2xl mb-4 leading-normal text-slate-800">タイトル</h2>
                <p id="modal-desc" class="text-sm font-medium leading-loose mb-8 text-slate-600">紹介文</p>
                
                <a id="modal-map-btn" href="#" target="_blank" rel="noopener noreferrer" class="mb-10 flex items-center justify-center gap-2 w-full border border-blue-900 text-blue-900 font-bold text-xs py-4 rounded hover:bg-blue-50 transition">
                    <i class="fa-solid fa-location-dot"></i>
                    <span data-i18n="modal-map-btn-text">この場所をGoogleマップで見る</span>
                </a>

                <div class="flex items-center justify-between border-t border-slate-200 pt-8 mb-8">
                    <span id="modal-author" class="text-[9px] font-bold text-gray-400 uppercase tracking-widest">PHOTO BY 管理者</span>
                    <a id="modal-sns" href="#" target="_blank" rel="noopener noreferrer" class="text-gray-900 font-bold text-[10px] border-b border-gray-900 pb-1 uppercase hover:opacity-70 transition">Instagram Link</a>
                </div>

                <div class="pt-6 border-t border-slate-200 text-center">
                    <p id="share-label" class="share-label text-[9px] font-bold text-slate-400 mb-4 tracking-widest uppercase" data-i18n="share-label">SHARE THIS SPOT</p>
                    <div class="share-btn-group">
                        <a id="share-x" href="#" target="_blank" rel="noopener noreferrer" class="share-btn x-twitter" title="X (Twitter)でシェア"><i class="fa-brands fa-x-twitter"></i></a>
                        <a id="share-fb" href="#" target="_blank" rel="noopener noreferrer" class="share-btn facebook" title="Facebookでシェア"><i class="fa-brands fa-facebook-f"></i></a>
                        <a id="share-line" href="#" target="_blank" rel="noopener noreferrer" class="share-btn line" title="LINEで送る"><i class="fa-brands fa-line"></i></a>
                        <button id="share-copy" class="share-btn copy-link" title="リンクをコピー"><i class="fa-solid fa-link"></i></button>
                    </div>
                    <p id="copy-success-msg" data-i18n="copy-success-msg">リンクをコピーしました！</p>
                </div>
            </div>
        </div>
    </div>

    <!-- ★ 新機能：三原の案内人AI (画像タコちゃんチャットボット) -->
    <div id="ai-chat-widget">
        <div id="ai-chat-window" class="hidden">
            <div id="ai-chat-header">
                <div class="flex items-center font-bold" data-i18n="ai-chat-title">
                    <img src="tako.png" class="w-7 h-7 rounded-full mr-2 object-cover border-2 border-white shadow-sm" alt="タコ">
                    <span>三原の案内人タコちゃん</span>
                </div>
                <button onclick="toggleChatWindow()"><i class="fa-solid fa-chevron-down"></i></button>
            </div>
            <div id="ai-chat-messages">
                <div class="chat-msg ai-msg" data-i18n="ai-chat-greeting">こんにちはタコ！三原市の観光スポットや周辺の美味しいお店について、何でも聞いてほしいタコ！</div>
            </div>
            <div id="ai-chat-input-area">
                <input type="text" id="ai-chat-input" placeholder="質問を入力してください..." data-i18n-placeholder="ai-chat-placeholder">
                <button id="ai-chat-send-btn" onclick="sendChatMessage()"><i class="fa-solid fa-paper-plane"></i></button>
            </div>
        </div>

        <!-- ★ タコちゃんの吹き出し（ふわふわ動きます） -->
        <div id="ai-chat-tooltip" class="ai-tooltip" data-i18n="ai-chat-tooltip">何でも聞いてタコ。</div>

        <!-- ★ 右下のフローティングボタン（タコの画像になります） -->
        <button id="ai-chat-btn" onclick="toggleChatWindow()">
            <img src="tako.png" alt="タコちゃん" onerror="this.style.display='none'">
        </button>
    </div>

    <script>
        // --- 言語・モード管理と辞書データ ---
        let currentLang = 'jp'; // 'jp' or 'en'
        let isRPGMode = false;

        const areaLabels = {
            'all': { jp: 'ぜんぶ', en: 'ALL' }, 'mihara': { jp: '三原市街', en: 'MIHARA' },
            'daiwa': { jp: '大和', en: 'DAIWA' }, 'kui': { jp: '久井', en: 'KUI' },
            'hongo': { jp: '本郷', en: 'HONGO' }, 'sagi': { jp: '佐木島', en: 'SAGI' }
        };

        const i18nData = {
            'header-logo': { normal: { jp: 'MIHARA REDISCOVER', en: 'MIHARA REDISCOVER' }, rpg: { jp: 'MIHARA QUEST', en: 'MIHARA QUEST' } },
            'nav-map': { normal: { jp: 'マップ', en: 'MAP' }, rpg: { jp: 'ちず', en: 'MAP' } },
            'nav-submit': { normal: { jp: '掲載募集', en: 'SUBMIT' }, rpg: { jp: 'ギルドへ', en: 'GUILD' } },
            'nav-guide': { normal: { jp: '掲載案内', en: 'GUIDELINES' }, rpg: { jp: 'おきて', en: 'RULES' } },
            'hero-label': { normal: { jp: 'MIHARA REDISCOVER PROJECT', en: 'MIHARA REDISCOVER PROJECT' }, rpg: { jp: 'MIHARA QUEST PROJECT', en: 'MIHARA QUEST PROJECT' } },
            'hero-title': { normal: { jp: 'まだ知らない三原の景色を、<br class="mobile-br">みんなで描くフォトマップ', en: 'Discovering the unseen Mihara,<br class="mobile-br">a community photo map.' }, rpg: { jp: '勇者よ、まだ見ぬ三原の<br>地図を完成させるのだ', en: 'O HERO!<br>THOU MUST COMPLETE THE UNSEEN MAP OF MIHARA.' } },
            'label-about': { normal: { jp: 'About Project', en: 'About Project' }, rpg: { jp: 'QUEST INFO', en: 'QUEST INFO' } },
            'title-about': { normal: { jp: 'みんなで描く、三原の未来', en: 'Mapping the Future of Mihara' }, rpg: { jp: '冒険の目的', en: 'THY MISSION' } },
            'desc-about': { normal: { jp: '広島県三原市（みはらし）は、瀬戸内海の穏やかな気候と豊かな自然に恵まれた、歴史と文化が息づく街です。陸・海・空の交通の要衝として知られ、「広島空港」がある空の玄関口でもあります。<br><br>このプロジェクトは、そんな三原の日常にある「美しさ」を再発見するためのもの。地元の人だけが知る特別な場所や、日常のふとした風景を写真で紡ぎ、共有していきます。', en: 'Mihara City in Hiroshima Prefecture is a town full of history and culture, blessed with the mild climate and rich nature of the Seto Inland Sea. It is known as a transportation hub for land, sea, and air, serving as the gateway to the sky with Hiroshima Airport.<br><br>This project aims to rediscover the everyday "beauty" of Mihara. We collect and share photos of special places known only to locals and casual everyday landscapes.' }, rpg: { jp: 'ここ ミハラは いにしえより つづく まち。<br><br>ゆうしゃよ、このせかいに かくれた<br>「うるわしきもの」を さがしだすのだ。<br><br>それが みつかりしとき、<br>あらたな でんせつが はじまるのだ。<br><br>さあ ゆくがよい！<br>ぼうけんの たびは はじまった！', en: 'Welcome to MIHARA, an ancient realm.<br><br>Brave traveler, seek out the HIDDEN BEAUTY scattered across this land.<br><br>When it is found, a new LEGEND shall begin.<br><br>Now, go forth! Thy QUEST has begun!' } },
            'title-map': { normal: { jp: 'PHOTO MAP', en: 'PHOTO MAP' }, rpg: { jp: 'WORLD MAP', en: 'WORLD MAP' } },
            'sub-map': { normal: { jp: 'Find Your Favorite Spot', en: 'Find Your Favorite Spot' }, rpg: { jp: 'Find Hidden Treasures', en: 'Find Hidden Treasures' } },
            'btn-view-grid-text': { normal: { jp: 'PHOTO', en: 'PHOTO' }, rpg: { jp: 'しらべる', en: 'SEARCH' } },
            'btn-view-map-text': { normal: { jp: 'MAP', en: 'MAP' }, rpg: { jp: 'ちず', en: 'MAP' } },
            'loading-text': { normal: { jp: 'Collecting memories...', en: 'Collecting memories...' }, rpg: { jp: 'ローディングちゅう...', en: 'Loading...' } },
            'load-more-btn': { normal: { jp: 'MORE PHOTOS', en: 'MORE PHOTOS' }, rpg: { jp: 'もっと さがす', en: 'EXPLORE MORE' } },
            'label-contact': { normal: { jp: 'Photo Submission', en: 'Photo Submission' }, rpg: { jp: 'Guild Request', en: 'GUILD REQUEST' } },
            'title-contact': { normal: { jp: '三原の魅力を教えてください', en: 'Share the Charm of Mihara' }, rpg: { jp: '情報をギルドに送る', en: 'REPORT TO GUILD' } },
            'desc-contact': { normal: { jp: '隠れた名所、美味しいグルメ、四季折々の風景、まちのイベント、あるいは何気ない日常のひとコマなど、三原の魅力が伝わる写真を幅広く募集しています。', en: 'We are looking for a wide range of photos that convey the charm of Mihara, such as hidden spots, delicious food, seasonal scenery, local events, or just casual everyday moments.' }, rpg: { jp: 'ミハラには まだみぬ 「うるわしき ケシキ」や<br>「ウマいもの」が かくされている。<br><br>たびびとよ、そなたのみつけた<br>「ミハラのキオク」を ギルドにおしえてくれ！', en: 'Undiscovered VISTAS and DELICACIES are hidden in MIHARA.<br><br>Brave traveler, share thy MEMORIES with the GUILD!' } },
            'contact-step-1': { normal: { jp: '以下の情報を添えて、Instagram<br>（<a href="https://www.instagram.com/mihara_sampo" target="_blank" rel="noopener noreferrer" class="underline decoration-blue-300">@mihara_sampo</a>）のDMよりお送りください。<br>内容を確認の上、サイトに追加させていただきます！', en: 'Please send a DM to our Instagram<br>(<a href="https://www.instagram.com/mihara_sampo" target="_blank" rel="noopener noreferrer" class="underline decoration-blue-300">@mihara_sampo</a>) with the following info.<br>We will add it to the map after review!' }, rpg: { jp: 'いかの じょうほうを そえて、Instagram<br>（<a href="https://www.instagram.com/mihara_sampo" target="_blank" rel="noopener noreferrer" class="text-[#f5d76e] underline">@mihara_sampo</a>）の DMより おくってくれ。<br>ギルドが かくにんしたのち、ちずに追加されるぞ！', en: 'Send a Raven (DM) to our Instagram<br>(<a href="https://www.instagram.com/mihara_sampo" target="_blank" rel="noopener noreferrer" class="text-[#f5d76e] underline">@mihara_sampo</a>) with the details below.<br>The GUILD shall record it on the map!' } },
            'req-info-title': { normal: { jp: 'Required Information', en: 'Required Information' }, rpg: { jp: 'ひつような もの', en: 'REQUIRED ITEMS' } },
            'req-info-1': { normal: { jp: '写真データ (JPEG/PNGなど)', en: 'Photo Data (JPEG/PNG)' }, rpg: { jp: 'うつしえ（しゃしんデータ）', en: 'Thy Picture (Photo)' } },
            'req-info-2': { normal: { jp: 'スポット名 / 紹介コメント', en: 'Spot Name / Comment' }, rpg: { jp: 'ばしょのなまえ / じょうほう', en: 'Location Name / Lore' } },
            'req-info-3': { normal: { jp: '撮影者名 / SNSリンク (任意)', en: 'Photographer / SNS Link (Optional)' }, rpg: { jp: 'そなたのなまえ / SNSリンク (にんい)', en: 'Thy Name / SNS Link (Optional)' } },
            'contact-via-insta': { normal: { jp: 'Contact via Instagram', en: 'Contact via Instagram' }, rpg: { jp: 'Contact via Instagram', en: 'Contact via Instagram' } },
            'insta-btn-text': { normal: { jp: 'InstagramでDMを送る', en: 'Send DM on Instagram' }, rpg: { jp: 'でんしょばと をおくる', en: 'SEND RAVEN' } },
            'label-guideline': { normal: { jp: 'Guidelines', en: 'Guidelines' }, rpg: { jp: 'Rules', en: 'RULES' } },
            'title-guideline': { normal: { jp: '写真掲載についてのご案内', en: 'Submission Guidelines' }, rpg: { jp: '冒険の掟', en: 'GUILD RULES' } },
            'guide-1-title': { normal: { jp: '写真掲載のルール', en: 'Rules for Publication' }, rpg: { jp: 'けいさいの おきて', en: 'RULES OF RECORDING' } },
            'guide-1-desc': { normal: { jp: '地域の魅力を伝えることを目的に、風景やお店、日常のひとコマを掲載しています。どなたでも自由に掲載できる仕組みではなく、ご連絡をいただいた内容を確認した上で掲載を行っています。', en: 'We post landscapes, shops, and everyday moments to convey the charm of the region. It is not a system where anyone can post freely; we review the submissions before publishing.' }, rpg: { jp: 'ちいきの みりょくを つたえるため、ふうけいや おみせの じょうほうを けいさいしている。だれでも じゆうに かきこめる わけではなく、ギルドが かくにんしてから けいさいするぞ。', en: 'To share the realm\'s beauty, we record vistas and merchants. Not just anyone may write in the tome; the GUILD reviews all lore before it is inscribed.' } },
            'guide-2-title': { normal: { jp: '権利とマナー', en: 'Rights and Manners' }, rpg: { jp: 'けんりと マナー', en: 'HONOR AND CONDUCT' } },
            'guide-2-desc': { normal: { jp: '著作権は撮影者本人にあります。人物や私有地が写る場合は、必ず権利者の許可を得てからご投稿ください。不適切な写真は掲載を見送る場合がございます。', en: 'The copyright belongs to the photographer. If people or private property are included, please obtain permission before submitting. Inappropriate photos may not be published.' }, rpg: { jp: 'ちょさくけん（けんり）は さつえいしゃに ある。ひとや しゆうちは、かならず きょか（ゆるし）を えてから ほうこくしてくれ。ふさわしくない うつしえは けいさいされないぞ。', en: 'The creator holds the rights. If folks or private realms appear, seek their blessing first. Unworthy imagery shall be rejected by the GUILD.' } },
            'guide-3-title': { normal: { jp: '写真の取り扱い', en: 'Handling of Photos' }, rpg: { jp: 'うつしえの あつかい', en: 'HANDLING OF RELICS' } },
            'guide-3-desc': { normal: { jp: 'ご提供いただいた写真は、当サイトや関連SNSにおいて三原を盛り上げる広報活動に大切に使用させていただきます。投稿者さんの意思を尊重し、丁寧に扱わせていただきます。', en: 'The provided photos will be carefully used on this site and related SNS to promote Mihara. We respect the photographer\'s intentions and handle them with care.' }, rpg: { jp: 'ていきょうされた うつしえは、このちずや SNSで ミハラを もりあげるために たいせつに つかわせてもらうぞ。さつえいしゃの いしを そんちょうし、ていねいに あつかうことを ちかおう。', en: 'Thy offered relics shall be carefully used in this map and beyond to spread the glory of MIHARA. We swear to respect thy will and handle them with utmost care.' } },
            'footer-copy': { normal: { jp: '&copy; 2026 Mihara Walk Photo Map', en: '&copy; 2026 Mihara Walk Photo Map' }, rpg: { jp: '&copy; 2026 Mihara Quest', en: '&copy; 2026 Mihara Quest' } },
            'modal-map-btn-text': { normal: { jp: 'この場所をGoogleマップで見る', en: 'View on Google Maps' }, rpg: { jp: 'ちずを ひらく', en: 'OPEN WORLD MAP' } },
            'share-label': { normal: { jp: 'SHARE THIS SPOT', en: 'SHARE THIS SPOT' }, rpg: { jp: 'SHARE THIS SPOT', en: 'SEND RAVEN' } },
            'copy-success-msg': { normal: { jp: 'リンクをコピーしました！', en: 'Link copied to clipboard!' }, rpg: { jp: 'ふしぎなじゅもんを コピーした！', en: 'Thou hast learned a new SPELL! (Copied)' } },

            // 天気用辞書
            'weather-mihara': { normal: { jp: '三原市の今の天気', en: 'CURRENT WEATHER' }, rpg: { jp: 'ミハラの そらもよう', en: 'MIHARA SKIES' } },
            'weather-magic-hour': { normal: { jp: 'MAGIC HOUR', en: 'MAGIC HOUR' }, rpg: { jp: 'ゆうぐれの とき', en: 'TWILIGHT' } },
            'weather-sunrise': { normal: { jp: 'SUNRISE', en: 'SUNRISE' }, rpg: { jp: 'よあけ', en: 'DAWN' } },
            'weather-weekly-toggle': { normal: { jp: '週間天気を見る', en: 'Weekly Forecast' }, rpg: { jp: 'このさきの そらもよう', en: 'Future Skies' } },

            // ★ 画像タコちゃんAIチャット用辞書
            'ai-chat-title': { 
                normal: { 
                    jp: '<img src="tako.png" class="w-6 h-6 rounded-full mr-2 object-cover border border-white" alt="タコ"><span>三原の案内人タコちゃん</span>', 
                    en: '<img src="tako.png" class="w-6 h-6 rounded-full mr-2 object-cover border border-white" alt="Taco"><span>Mihara Guide Taco</span>' 
                }, 
                rpg: { 
                    jp: '<img src="tako.png" class="w-6 h-6 rounded-full mr-2 object-cover border border-white" alt="タコ"><span>みちびきの タコ</span>', 
                    en: '<img src="tako.png" class="w-6 h-6 rounded-full mr-2 object-cover border border-white" alt="Octopus"><span>Guide Octopus</span>' 
                } 
            },
            'ai-chat-greeting': { normal: { jp: 'こんにちはタコ！三原市の観光スポットや周辺の美味しいお店について、何でも聞いてほしいタコ！', en: 'Hello! Ask me anything about sightseeing spots or local food in Mihara!' }, rpg: { jp: 'よくぞ きた ゆうしゃよ！ わしは みちびきのタコ。ミハラの ちずの ことなら なんなりと きくタコ。', en: 'Welcome, Hero! Ask me anything about the map of Mihara.' } },
            'ai-chat-placeholder': { normal: { jp: '質問を入力してください...', en: 'Type your question...' }, rpg: { jp: 'ききたいことを いれるのだ...', en: 'Ask thy question...' } },
            'ai-chat-tooltip': { normal: { jp: '何でも聞いてタコ。', en: 'Ask me anything, Taco!' }, rpg: { jp: 'なんでも きくタコ。', en: 'Ask away, Taco!' } }
        };

        // --- ウェザー API 連携機能 ---
        let weatherDataCache = null;
        async function fetchWeather() {
            try {
                const lat = 34.3964; const lng = 133.0781;
                const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lng}&current_weather=true&daily=sunrise,sunset,weathercode,temperature_2m_max,temperature_2m_min&timezone=Asia%2FTokyo`;
                const response = await fetch(url);
                if (!response.ok) throw new Error('Weather fetch failed');
                const data = await response.json();
                updateWeatherUI(data);
            } catch (e) {
                console.error('Weather API Error:', e);
                document.getElementById('weather-temp-text').textContent = '--°C';
                document.getElementById('weather-desc').textContent = currentLang === 'en' ? 'Unavailable' : '取得失敗';
            }
        }

        function updateWeatherUI(data) {
            if (data) weatherDataCache = data;
            else data = weatherDataCache;
            if (!data) return;

            const current = data.current_weather;
            const daily = data.daily;
            const currentInfo = getWeatherInfo(current.weathercode, currentLang, isRPGMode);

            document.getElementById('weather-main-icon').className = `fa-solid ${currentInfo.iconClass}`;
            document.getElementById('weather-temp-text').textContent = `${current.temperature}°C`;
            document.getElementById('weather-desc').textContent = currentInfo.text;

            const formatTime = (date) => `${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}`;
            const sunriseStr = formatTime(new Date(daily.sunrise[0]));
            const sunsetStr = formatTime(new Date(daily.sunset[0]));

            let magicHourPreText = isRPGMode ? (currentLang === 'en' ? 'Best View: ' : 'シャッターチャンス: ') : (currentLang === 'en' ? 'Sunset Time: ' : '夕焼けチャンス: ');
            document.getElementById('magic-hour-text').textContent = magicHourPreText + sunsetStr;
            document.getElementById('sunrise-text').textContent = sunriseStr;

            const weeklyList = document.getElementById('weekly-forecast-list');
            if(weeklyList) {
                weeklyList.innerHTML = '';
                for(let i = 0; i < 7; i++) {
                    const dObj = new Date(daily.time[i]);
                    const dayJp = ['日', '月', '火', '水', '木', '金', '土'][dObj.getDay()];
                    const dayEn = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'][dObj.getDay()];
                    const dayLabel = currentLang === 'en' ? dayEn : dayJp;
                    const maxT = Math.round(daily.temperature_2m_max[i]);
                    const minT = Math.round(daily.temperature_2m_min[i]);
                    const wInfo = getWeatherInfo(daily.weathercode[i], currentLang, isRPGMode);
                    
                    const dayEl = document.createElement('div');
                    dayEl.className = "flex flex-col items-center flex-1 min-w-[42px]";
                    dayEl.innerHTML = `
                        <span class="text-[10px] text-gray-400 font-bold mb-1.5 weekly-day-label">${i === 0 ? (currentLang === 'en' ? 'Today' : '今日') : dayLabel}</span>
                        <i class="fa-solid ${wInfo.iconClass} text-[15px] mb-1.5"></i>
                        <div class="text-[9px] font-bold flex gap-1.5 mt-auto">
                            <span class="text-red-400">${maxT}°</span><span class="text-blue-500">${minT}°</span>
                        </div>
                    `;
                    weeklyList.appendChild(dayEl);
                }
            }
        }

        function getWeatherInfo(code, lang, isRpg) {
            let iconClass = 'fa-cloud text-gray-400';
            let weatherTextJp = '曇り'; let weatherTextEn = 'Cloudy'; let weatherTextRpgJp = 'くもり'; let weatherTextRpgEn = 'Cloudy';
            if (code === 0) { iconClass = 'fa-sun text-orange-500'; weatherTextJp = '晴れ'; weatherTextEn = 'Clear'; weatherTextRpgJp = 'はれ'; weatherTextRpgEn = 'Clear'; }
            else if (code === 1 || code === 2) { iconClass = 'fa-cloud-sun text-orange-400'; weatherTextJp = '晴れ時々曇り'; weatherTextEn = 'Partly Cloudy'; weatherTextRpgJp = 'はれ ときどき くもり'; weatherTextRpgEn = 'Partly Cloudy'; }
            else if (code === 3) { iconClass = 'fa-cloud text-gray-400'; weatherTextJp = '曇り'; weatherTextEn = 'Cloudy'; weatherTextRpgJp = 'くもり'; weatherTextRpgEn = 'Cloudy'; }
            else if (code === 45 || code === 48) { iconClass = 'fa-smog text-gray-400'; weatherTextJp = '霧'; weatherTextEn = 'Fog'; weatherTextRpgJp = 'きり'; weatherTextRpgEn = 'Fog'; }
            else if (code >= 51 && code <= 67) { iconClass = 'fa-umbrella text-blue-500'; weatherTextJp = '雨'; weatherTextEn = 'Rain'; weatherTextRpgJp = 'あめ'; weatherTextRpgEn = 'Rain'; }
            else if (code >= 71 && code <= 77) { iconClass = 'fa-snowflake text-blue-300'; weatherTextJp = '雪'; weatherTextEn = 'Snow'; weatherTextRpgJp = 'ゆき'; weatherTextRpgEn = 'Snow'; }
            else if (code >= 80 && code <= 82) { iconClass = 'fa-cloud-showers-heavy text-blue-600'; weatherTextJp = 'にわか雨'; weatherTextEn = 'Showers'; weatherTextRpgJp = 'にわかあめ'; weatherTextRpgEn = 'Showers'; }
            else if (code >= 95) { iconClass = 'fa-bolt text-yellow-500'; weatherTextJp = '雷雨'; weatherTextEn = 'Thunderstorm'; weatherTextRpgJp = 'らいう'; weatherTextRpgEn = 'Storm'; }
            return { iconClass, text: isRpg ? (lang === 'en' ? weatherTextRpgEn : weatherTextRpgJp) : (lang === 'en' ? weatherTextEn : weatherTextJp) };
        }

        function toggleWeeklyWeather() {
            const container = document.getElementById('weekly-weather-container');
            const icon = document.getElementById('weekly-toggle-icon');
            if (container.style.maxHeight && container.style.maxHeight !== '0px') {
                container.style.maxHeight = '0px'; container.style.opacity = '0'; icon.style.transform = 'rotate(0deg)';
            } else {
                container.style.maxHeight = '150px'; container.style.opacity = '1'; icon.style.transform = 'rotate(180deg)';
            }
        }

        // --- ★ 新機能：Gemini API 連携 (バックエンドAPI経由) ---
        let chatHistory = [];

        function toggleChatWindow() {
            const windowEl = document.getElementById('ai-chat-window');
            const widgetEl = document.getElementById('ai-chat-widget');
            
            windowEl.classList.toggle('hidden');
            widgetEl.classList.toggle('open'); // ★吹き出しを消すためのクラス切り替え
            
            if (!windowEl.classList.contains('hidden')) {
                document.getElementById('ai-chat-input').focus();
            }
        }

        async function callGeminiAPI(userQuery, retries = 5) {
            // ★ 自作のバックエンドAPI（chat.js）を呼び出します（APIキーは裏側に隠れます）
            const url = `/api/chat`;
            
            // CSVデータからAIに教えるための簡易リストを作成（トークン節約のため主要項目のみ）
            const spotsContext = spotsData.slice(0, 50).map(s => `- ${s.title}: ${s.desc} (エリア: ${s.area})`).join('\n');
            
            const systemInstruction = `あなたは広島県三原市の親切でフレンドリーな観光案内人「タコちゃん」です。（三原市はタコが名物です！）
以下の三原市の観光スポットデータを参考にして、ユーザーの質問に答えてください。
回答は長くても3〜4文程度にまとめ、スマホで読みやすくしてください。
一人称は「私」または「タコちゃん」、語尾に「〜タコ！」「〜だタコ」などを自然な範囲で混ぜて、可愛らしく、親しみやすく案内してください。
データに該当するスポットがあれば優先して紹介し、さらにGoogle検索機能を使って周辺の美味しいランチ情報や行き方なども積極的に補足して楽しく案内してください。

【サイトに掲載されている三原市スポットデータ（一部）】
${spotsContext}
`;

            const payload = {
                contents: [
                    ...chatHistory,
                    { parts: [{ text: userQuery }] }
                ],
                systemInstruction: { parts: [{ text: systemInstruction }] },
                tools: [{ "google_search": {} }] // ★ Google検索（グラウンディング）を有効化
            };

            const delays = [1000, 2000, 4000, 8000, 16000];
            
            for (let i = 0; i <= retries; i++) {
                try {
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    
                    const responseData = await response.json();

                    // 万が一エラーが返ってきたら、その理由を拾い上げる
                    if (!response.ok) {
                        throw new Error(`エラーコード: ${response.status} / 理由: ${responseData.error || ''} ${responseData.details || ''}`);
                    }
                    
                    const text = responseData.candidates?.[0]?.content?.parts?.[0]?.text;
                    if (text) {
                        chatHistory.push({ role: "user", parts: [{ text: userQuery }] });
                        chatHistory.push({ role: "model", parts: [{ text: text }] });
                        return text;
                    } else {
                        throw new Error("AIからの返答が空っぽだったタコ。");
                    }
                } catch (error) {
                    if (i === retries) {
                        console.error("Gemini API Error:", error);
                        // ★ エラーの「具体的な原因」をタコちゃんが喋るようにしました！
                        return `ごめんタコ〜、エラーが発生したみたいだタコ。（詳細: ${error.message}）もう一度聞いてほしいタコ！`;
                    }
                    await new Promise(resolve => setTimeout(resolve, delays[i]));
                }
            }
        }

        async function sendChatMessage() {
            const inputEl = document.getElementById('ai-chat-input');
            const msg = inputEl.value.trim();
            if (!msg) return;

            inputEl.value = '';
            appendChatMessage('user', msg);
            
            const sendBtn = document.getElementById('ai-chat-send-btn');
            sendBtn.disabled = true;
            inputEl.disabled = true;
            
            const loadingId = appendChatLoading();
            
            // API呼び出し
            const aiResponse = await callGeminiAPI(msg);
            
            removeChatMessage(loadingId);
            appendChatMessage('ai', aiResponse);
            
            sendBtn.disabled = false;
            inputEl.disabled = false;
            inputEl.focus();
        }

        function appendChatMessage(sender, text) {
            const messagesEl = document.getElementById('ai-chat-messages');
            const msgDiv = document.createElement('div');
            msgDiv.className = `chat-msg ${sender}-msg`;
            
            // 簡易マークダウンパース (太字と改行)
            let htmlText = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\n/g, '<br>');
            msgDiv.innerHTML = htmlText;
            
            messagesEl.appendChild(msgDiv);
            messagesEl.scrollTop = messagesEl.scrollHeight;
        }

        function appendChatLoading() {
            const messagesEl = document.getElementById('ai-chat-messages');
            const msgDiv = document.createElement('div');
            const id = 'loading-' + Date.now();
            msgDiv.id = id;
            msgDiv.className = `chat-msg ai-msg`;
            msgDiv.innerHTML = '<i class="fa-solid fa-ellipsis fa-fade"></i> 考え中タコ...';
            messagesEl.appendChild(msgDiv);
            messagesEl.scrollTop = messagesEl.scrollHeight;
            return id;
        }

        function removeChatMessage(id) {
            const el = document.getElementById(id);
            if (el) el.remove();
        }

        // --- UI更新処理 ---
        function updateUI() {
            const mode = isRPGMode ? 'rpg' : 'normal';
            
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if (i18nData[key] && i18nData[key][mode] && i18nData[key][mode][currentLang]) {
                    el.innerHTML = i18nData[key][mode][currentLang];
                }
            });

            // チャットのプレースホルダー更新
            document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
                const key = el.getAttribute('data-i18n-placeholder');
                if (i18nData[key] && i18nData[key][mode] && i18nData[key][mode][currentLang]) {
                    el.setAttribute('placeholder', i18nData[key][mode][currentLang]);
                }
            });

            document.querySelectorAll('.tab-item').forEach(el => {
                const area = el.getAttribute('data-area');
                if (areaLabels[area]) el.textContent = areaLabels[area][currentLang];
            });

            const rpgBtnText = isRPGMode ? (currentLang === 'en' ? 'RETURN' : '現代に戻る') : (currentLang === 'en' ? 'QUEST MODE' : '冒険の扉');
            document.getElementById('rpg-btn-text').textContent = rpgBtnText;
            document.getElementById('rpg-btn-icon').className = isRPGMode ? 'fa-solid fa-book-open' : 'fa-solid fa-dungeon';
            document.getElementById('lang-text').textContent = currentLang === 'jp' ? 'EN' : 'JP';

            updateWeatherUI();

            if(spotsData.length > 0) render(currentActiveArea);
            
            const modal = document.getElementById('photo-modal');
            if (modal.classList.contains('active') && modal._currentSpot) {
                updateModalText(modal._currentSpot);
            }
        }

        function toggleRPGMode() {
            isRPGMode = !isRPGMode;
            document.body.classList.toggle('rpg-mode', isRPGMode);
            updateUI();
        }

        function toggleLanguage() {
            currentLang = currentLang === 'jp' ? 'en' : 'jp';
            updateUI();
        }

        function getLocalizedSpotField(spot, field) {
            const lang = currentLang;
            const mode = isRPGMode ? 'rpg' : 'normal';
            if (field === 'title') {
                if (mode === 'rpg' && lang === 'en') return spot.rpg_title_en || spot.title_en || spot.rpg_title || spot.title || 'Unknown Area';
                if (mode === 'rpg' && lang === 'jp') return spot.rpg_title || spot.title || '名もなき場所';
                if (mode === 'normal' && lang === 'en') return spot.title_en || spot.title || 'Unknown Area';
                return spot.title || '名称未設定';
            }
            if (field === 'desc') {
                const defaultDesc = { normal: { jp: '紹介文はありません。', en: 'No description available.' }, rpg: { jp: 'まだ だれも しらない ばしょのようだ...', en: 'An uncharted territory...' } };
                const def = defaultDesc[mode][lang];
                if (mode === 'rpg' && lang === 'en') return spot.rpg_desc_en || spot.desc_en || spot.rpg_desc || spot.desc || def;
                if (mode === 'rpg' && lang === 'jp') return spot.rpg_desc || spot.desc || def;
                if (mode === 'normal' && lang === 'en') return spot.desc_en || spot.desc || def;
                return spot.desc || def;
            }
            return '';
        }

        function scrollToId(id) {
            const el = document.getElementById(id);
            if (el) window.scrollTo({ top: el.getBoundingClientRect().top + window.pageYOffset - 60, behavior: 'smooth' });
        }

        let currentSlide = 0;
        const slides = document.querySelectorAll('.slide');
        function rotateSlides() {
            if (slides.length < 2) return;
            setInterval(() => {
                slides[currentSlide].classList.remove('active');
                currentSlide = (currentSlide + 1) % slides.length;
                slides[currentSlide].classList.add('active');
            }, 6000);
        }

        const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vR0jkQnLXsIL33pmO60BCd0hIr_v5xh34cJ_IWAHkF0pTaj855pzicmNoVx6W8CPK3MEhlp-irodPSE/pub?gid=1232979489&single=true&output=csv";
        let spotsData = [];
        
        const AREA_POSITIONS = { 'all': { lat: 34.4200, lng: 133.0800, zoom: 11 }, 'mihara': { lat: 34.4000, lng: 133.0800, zoom: 13 }, 'daiwa': { lat: 34.5300, lng: 132.9500, zoom: 12 }, 'kui': { lat: 34.5600, lng: 133.0500, zoom: 12 }, 'hongo': { lat: 34.4200, lng: 132.9200, zoom: 12 }, 'sagi': { lat: 34.3300, lng: 133.1100, zoom: 12 } };
        const ITEMS_PER_PAGE = 12;
        let currentFilteredData = [];
        let displayedCount = 0;
        let currentActiveArea = 'all';
        let mapInstance = null;
        let markersClusterGroup = null; 
        let currentViewMode = 'grid'; 

        function formatDriveUrl(urlOrId, size = 'w1000') {
            if (!urlOrId) return '';
            const str = urlOrId.toString();
            const idMatch = str.match(/[-\w]{25,}/);
            if ((str.includes('google') || !str.startsWith('http')) && idMatch) return `https://drive.google.com/thumbnail?id=${idMatch[0]}&sz=${size}`;
            if (str.startsWith('http')) return str.replace('http://', 'https://');
            return '';
        }

        function switchView(mode) {
            currentViewMode = mode;
            const gridWrap = document.getElementById('gallery-wrap');
            const mapContainer = document.getElementById('map-container');
            const btnGrid = document.getElementById('btn-view-grid');
            const btnMap = document.getElementById('btn-view-map');
            
            if (mode === 'grid') {
                gridWrap.style.display = 'block'; mapContainer.classList.remove('active');
                btnGrid.classList.add('active'); btnMap.classList.remove('active');
            } else {
                gridWrap.style.display = 'none'; mapContainer.classList.add('active');
                btnGrid.classList.remove('active'); btnMap.classList.add('active');
                if (!mapInstance) initMap(); else setTimeout(() => { mapInstance.invalidateSize(); }, 200);
                updateMapMarkers();
            }
        }

        function initMap() {
            const initPos = AREA_POSITIONS['all'];
            mapInstance = L.map('map-container').setView([initPos.lat, initPos.lng], initPos.zoom);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', { attribution: '© OSM', subdomains: 'abcd', maxZoom: 19 }).addTo(mapInstance);
            markersClusterGroup = L.markerClusterGroup({ showCoverageOnHover: false, maxClusterRadius: 50, spiderfyOnMaxZoom: true });
            mapInstance.addLayer(markersClusterGroup);
        }

        function updateMapMarkers() {
            if (!mapInstance || !markersClusterGroup) return;
            markersClusterGroup.clearLayers();
            let hasMarkers = false;

            currentFilteredData.forEach(spot => {
                if (spot.lat && spot.lng) {
                    const lat = parseFloat(spot.lat); const lng = parseFloat(spot.lng);
                    if (isNaN(lat) || isNaN(lng)) return;
                    hasMarkers = true;

                    const imgUrl = formatDriveUrl(spot.image, 'w500');
                    const areaLabel = areaLabels[spot.area] ? areaLabels[spot.area][currentLang] : (currentLang==='en'?'MIHARA':'三原');
                    const popupContent = `
                        <div onclick="openModalFromMap('${spot.title.replace(/'/g, "\\'")}')" style="cursor:pointer;">
                            <div class="popup-img-wrap"><img src="${imgUrl}" class="popup-img" onerror="this.src='https://placehold.co/200x130/e2e8f0/94a3b8?text=No+Image';"></div>
                            <div class="popup-info">
                                <span class="popup-area">${areaLabel}</span>
                                <div class="popup-title">${getLocalizedSpotField(spot, 'title')}</div>
                                <div class="popup-more">${currentLang === 'en' ? 'Details' : '詳細を見る'} <i class="fa-solid fa-chevron-right text-[8px]"></i></div>
                            </div>
                        </div>`;
                    markersClusterGroup.addLayer(L.marker([lat, lng]).bindPopup(popupContent));
                }
            });
            if (hasMarkers) mapInstance.fitBounds(markersClusterGroup.getBounds(), { padding: [50, 50], maxZoom: 15 });
            else { const set = AREA_POSITIONS[currentActiveArea] || AREA_POSITIONS['all']; mapInstance.setView([set.lat, set.lng], set.zoom); }
        }

        window.openModalFromMap = function(targetTitle) {
            const target = spotsData.find(s => s.title === targetTitle);
            if (target) openModal(target);
        };

        function render(filter) {
            currentActiveArea = filter; 
            const grid = document.getElementById('gallery-grid');
            const loadMoreArea = document.getElementById('load-more-area');
            const filtered = filter === 'all' ? [...spotsData] : spotsData.filter(s => s.area === filter);
            currentFilteredData = filtered.reverse();

            grid.innerHTML = '';
            displayedCount = 0;

            if (currentFilteredData.length === 0) {
                grid.innerHTML = `<div class="col-span-3 py-32 text-center text-[10px] font-bold text-gray-300 uppercase tracking-widest">${currentLang === 'en' ? 'No Items Found' : 'データがありません'}</div>`;
                loadMoreArea.classList.add('hidden');
            } else loadMoreItems();

            if (currentViewMode === 'map') updateMapMarkers();
        }

        const itemObserver = new IntersectionObserver((entries, obs) => {
            entries.forEach(e => { if (e.isIntersecting) { e.target.classList.add('in-view'); obs.unobserve(e.target); }});
        }, { threshold: 0.25 });

        function loadMoreItems() {
            const grid = document.getElementById('gallery-grid');
            const loadMoreArea = document.getElementById('load-more-area');
            const nextItems = currentFilteredData.slice(displayedCount, displayedCount + ITEMS_PER_PAGE);

            nextItems.forEach(spot => {
                const img = formatDriveUrl(spot.image, 'w500');
                const areaName = areaLabels[spot.area] ? areaLabels[spot.area][currentLang] : (currentLang==='en'?'MIHARA':'三原');
                const item = document.createElement('div');
                item.className = 'photo-item';
                item.onclick = () => openModal(spot);
                item.innerHTML = `
                    <img src="${img}" loading="lazy" alt="${getLocalizedSpotField(spot, 'title')}" onerror="this.parentElement.classList.add('error-img')">
                    <div class="photo-overlay">
                        <span class="text-[9px] text-white font-bold tracking-widest uppercase mb-1">${areaName}</span>
                        <span class="text-sm text-white font-bold serif-custom drop-shadow-md">${getLocalizedSpotField(spot, 'title')}</span>
                    </div>
                `;
                grid.appendChild(item);
                itemObserver.observe(item);
            });
            displayedCount += nextItems.length;
            if (displayedCount < currentFilteredData.length) loadMoreArea.classList.remove('hidden');
            else loadMoreArea.classList.add('hidden');
        }

        function updateUrlParams(spotTitle) {
            if (!history.pushState) return;
            const newUrl = window.location.protocol + "//" + window.location.host + window.location.pathname + '?spot=' + encodeURIComponent(spotTitle) + '&lang=' + currentLang;
            window.history.pushState({path: newUrl}, '', newUrl);
            const spot = spotsData.find(s => s.title === spotTitle);
            if(spot) {
                document.title = `${getLocalizedSpotField(spot, 'title')} | MIHARA REDISCOVER`;
                const descMeta = document.querySelector('meta[name="description"]');
                if(descMeta) {
                    let descText = getLocalizedSpotField(spot, 'desc').replace(/\n/g, '');
                    if(descText.length > 100) descText = descText.substring(0, 100) + '...';
                    descMeta.setAttribute('content', descText);
                }
            }
            const linkCanonical = document.getElementById('canonical-tag');
            if (linkCanonical) linkCanonical.setAttribute('href', newUrl);
        }

        function clearUrlParams() {
            if (!history.pushState) return;
            const newUrl = window.location.protocol + "//" + window.location.host + window.location.pathname + '?lang=' + currentLang;
            window.history.pushState({path: newUrl}, '', newUrl);
            document.title = currentLang === 'en' ? "Mihara Walk PHOTO MAP" : "三原市まち歩き - PHOTO MAP | 三原市の魅力を再発見するプロジェクト";
            const descMeta = document.querySelector('meta[name="description"]');
            if(descMeta) descMeta.setAttribute('content', currentLang === 'en' ? "A photo map project to rediscover the charm of Mihara, Hiroshima." : "広島県三原市の魅力を再発見するフォトマッププロジェクト。");
            const linkCanonical = document.getElementById('canonical-tag');
            if (linkCanonical) linkCanonical.setAttribute('href', window.location.protocol + "//" + window.location.host + window.location.pathname);
        }

        function updateModalText(spot) {
            document.getElementById('modal-title').textContent = getLocalizedSpotField(spot, 'title');
            document.getElementById('modal-desc').innerHTML = getLocalizedSpotField(spot, 'desc').replace(/\n/g, '<br>');
            const areaKey = spot.area || 'all';
            document.getElementById('modal-area').textContent = areaLabels[areaKey] ? areaLabels[areaKey][currentLang] : (currentLang === 'en' ? 'MIHARA' : '三原');
            document.getElementById('modal-author').textContent = 'PHOTO BY ' + (spot.author || spot.nickname || spot.name || (currentLang === 'en' ? 'Admin' : '管理者'));
        }

        function openModal(spot) {
            const modalImg = document.getElementById('modal-img');
            modalImg.style.display = 'block'; 
            modalImg.src = formatDriveUrl(spot.image, 'w1600');
            modalImg.alt = getLocalizedSpotField(spot, 'title');
            
            const modal = document.getElementById('photo-modal');
            modal._currentSpot = spot;
            updateModalText(spot);

            const snsLink = spot.sns || spot.snsurl || spot.url || spot.link;
            const snsEl = document.getElementById('modal-sns');
            if (snsLink && snsLink.startsWith('http')) {
                snsEl.style.display = 'block'; snsEl.href = snsLink; snsEl.textContent = 'INSTAGRAM LINK';
                snsEl.style.color = '#1a1a1a'; snsEl.style.borderColor = '#1a1a1a'; snsEl.style.pointerEvents = 'auto';
            } else {
                snsEl.style.display = 'block'; snsEl.removeAttribute('href'); snsEl.textContent = 'NO SNS ACCOUNT';
                snsEl.style.color = '#ccc'; snsEl.style.borderColor = 'transparent'; snsEl.style.pointerEvents = 'none';
            }

            const mapBtn = document.getElementById('modal-map-btn');
            if (mapBtn) {
                mapBtn.href = spot.map_url && spot.map_url.trim() !== "" ? spot.map_url.trim() : (spot.lat && spot.lng ? `https://www.google.com/maps/search/?api=1&query=${spot.lat},${spot.lng}` : `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent("三原市 " + spot.title)}`);
            }

            const shareUrl = window.location.protocol + "//" + window.location.host + window.location.pathname + '?spot=' + encodeURIComponent(spot.title) + '&lang=' + currentLang;
            const shareText = `${currentLang === 'en' ? `Found a hidden gem in Mihara! "${getLocalizedSpotField(spot, 'title')}"` : `三原のいいとこ見つけた！「${getLocalizedSpotField(spot, 'title')}」`}\n#三原市まち歩き #Mihara`;

            document.getElementById('share-x').href = `https://twitter.com/intent/tweet?text=${encodeURIComponent(shareText)}&url=${encodeURIComponent(shareUrl)}`;
            document.getElementById('share-fb').href = `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(shareUrl)}`;
            document.getElementById('share-line').href = `https://social-plugins.line.me/lineit/share?url=${encodeURIComponent(shareUrl)}`;
            
            const copyBtn = document.getElementById('share-copy');
            const copyMsg = document.getElementById('copy-success-msg');
            copyMsg.classList.remove('show');
            copyBtn.onclick = () => { navigator.clipboard.writeText(shareUrl).then(() => { copyMsg.classList.add('show'); setTimeout(() => copyMsg.classList.remove('show'), 2000); }); };

            modal.classList.add('active');
            document.body.style.overflow = 'hidden';
            updateUrlParams(spot.title);
        }

        function closeModal() {
            document.getElementById('photo-modal').classList.remove('active');
            document.body.style.overflow = 'auto';
            document.getElementById('copy-success-msg').classList.remove('show');
            clearUrlParams();
        }

        window.addEventListener('load', () => {
            fetchWeather();
            
            // チャットのエンターキー送信
            document.getElementById('ai-chat-input').addEventListener('keypress', function (e) {
                if (e.key === 'Enter') sendChatMessage();
            });

            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('lang') === 'en' || urlParams.get('lang') === 'jp') {
                currentLang = urlParams.get('lang');
            }
            updateUI();
            rotateSlides();

            const modal = document.getElementById('photo-modal');
            const modalContent = document.getElementById('modal-content-area');
            const closeBtn = document.getElementById('modal-close-btn');
            modal.addEventListener('click', (e) => { if (e.target === modal) closeModal(); });
            closeBtn.addEventListener('click', closeModal);
            modalContent.addEventListener('click', (e) => e.stopPropagation());

            Papa.parse(CSV_URL, {
                download: true, header: true, skipEmptyLines: true,
                complete: function(results) {
                    spotsData = results.data.map(row => {
                        const clean = {};
                        Object.keys(row).forEach(k => {
                            let cleanKey = k.replace(/^[\s\u3000]+|[\s\u3000]+$/g, '').toLowerCase(); 
                            clean[cleanKey] = (typeof row[k] === 'string') ? row[k].trim() : row[k];
                        });
                        if (!clean.map_url) clean.map_url = clean['googleマップのurl'] || clean['googleマップのurl(共有リンク)'] || clean['googleマップのurl（共有リンク）'] || clean['地図url'] || clean['googlemap'] || '';
                        return clean;
                    }).filter(s => s.title);
                    
                    render('all');

                    const targetSpotTitle = urlParams.get('spot');
                    if (targetSpotTitle) {
                        const target = spotsData.find(s => s.title === targetSpotTitle);
                        if (target) openModal(target);
                    }
                },
                error: function(err) {
                    console.error("CSV Error:", err);
                    document.getElementById('gallery-grid').innerHTML = '<div class="col-span-3 py-10 text-center text-xs text-red-400">データの読み込みに失敗しました。</div>';
                }
            });

            document.querySelectorAll('.tab-item').forEach(tab => {
                tab.addEventListener('click', () => {
                    render(tab.getAttribute('data-area'));
                    document.querySelectorAll('.tab-item').forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                });
            });
        });
    </script>
</body>
</html>